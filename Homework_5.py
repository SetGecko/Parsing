# ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣀⣀⣤⣤⣤⣤⣤⣤⣀⡀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
# ⠄⠄⠄⠄⠄⠄⣀⣴⣶⡿⠛⣿⠋⠉⠉⠉⠉⠉⠙⠛⠿⣶⣤⡀⠄⠄⠄⠄⠄⠄
# ⠄⠄⠄⠄⢀⣴⠟⠉⠹⣧⣤⣿⣷⣤⣀⡆⠄⠄⠄⠄⠄⠄⠉⢻⣦⡀⠄⠄⠄⠄
# ⠄⠄⠄⣴⡿⠃⠄⣠⣿⣿⣿⣿⣿⣿⣿⣿⣦⣄⣀⠄⠄⠄⠄⠄⠙⢿⣆⠄⠄⠄
# ⠄⠄⣼⡟⠄⣤⣴⣿⣿⣿⣿⣿⣿⣿⣿⣤⣽⣿⣿⣟⠄⠄⠄⠄⠄⠈⢻⣧⠄⠄
# ⠄⣸⡟⠄⢠⣿⣿⣿⣿⣿⢿⣿⣿⣿⣿⣟⡉⠙⠻⣿⣷⣦⣤⣀⡀⠄⠄⢻⡇⠄
# ⠄⣿⠃⠄⠸⣿⣿⣿⣿⣿⡎⠿⣿⠿⠛⠙⠻⢦⡀⠈⢻⣿⣶⣿⡇⠄⠄⢸⣿⠄
# ⢰⣿⠄⠄⢠⣿⣿⣿⣿⣿⣇⠄⠄⠄⠄⠄⠄⠄⠹⣶⣬⣤⡽⣎⠁⠄⠄⠄⣿⠄
# ⠸⣿⠄⠒⢿⣿⣿⣿⣿⣿⣿⣿⣦⣤⣤⣤⣤⣀⣀⡀⠄⠄⠄⠘⡆⠄⠄⠄⣿⠄
# ⠄⣿⡆⠄⠈⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣄⠄⠄⢛⠒⠒⢹⡿⠄
# ⠄⢸⣧⠄⠄⠄⠈⢻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡀⠄⠁⠄⣼⠇⠄
# ⠄⠄⢻⣧⡀⠄⠄⣸⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠄⢀⣼⠟⠄⠄
# ⠄⠄⠄⠹⣿⣦⡀⠄⠄⠈⠛⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣠⣾⠋⠄⠄⠄
# ⠄⠄⠄⠄⠈⠻⣿⣦⣄⣀⣀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠁⠄⠄⠄⠄
# ⠄⠄⠄⠄⠄⠄⠈⠛⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠋⠁⠄⠄⠄⠄⠄⠄
# ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠉⠙⠛⠛⠛⠛⠋⠉⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
# ⠠⣤⡄⠄⣤⡤⢠⣤⣤⣤⢠⣤⠤⣤⡀⣤⣤⣤⡄⠄⣤⣤⠄⠄⢤⣤⠄⠄⠄⠄
# ⠄⣿⣧⢀⣿⡇⢸⡇⠄⣿⢸⣿⠄⢸⡇⠄⣿⡇⠄⢠⣿⢻⡆⠄⢸⣿⠄⠄⠄⠄
# ⠄⣿⢻⣿⢹⡇⢸⡇⠄⣿⢸⣿⠻⣯⡁⠄⣿⡇⠄⣼⠷⠾⣿⠄⢸⣿⠄⠄⠄⠄
# ⢠⣿⡈⠟⢸⣇⠸⣷⣶⡿⢸⣿⠄⢸⣿⢀⣿⡇⠰⣿⠄⠄⣿⠆⢸⣿⣤⣤⠇⠄
# ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
# ⠐⣿⢀⣼⠟⠄⣾⠛⢻⣷⢸⣷⠄⢰⣿⠁⢸⣿⠛⣿⠄⠄⣼⣿⡆⢸⠛⣿⠛⠇
# ⠄⣿⣾⣇⠄⠄⣿⠄⢸⣿⢸⣿⣧⣼⣿⠄⢸⣿⠶⣿⠄⢰⣿⢸⣧⠄⠄⣿⠄⠄
# ⠄⣿⠈⢻⣆⠄⣿⠄⢸⣿⢸⣿⢻⡇⣿⠄⢸⣿⠄⣿⠄⣸⡏⠉⢿⡆⠄⣿⠄⠄
# ⠘⠛⠂⠐⠛⠃⠙⠛⠛⠋⠘⠛⠈⠄⠛⠂⠚⠛⠛⠛⠐⠛⠄⠄⠚⠛⠐⠛⠂⠄

import datetime
import locale
import re
import time

from selenium import webdriver
from selenium.common import exceptions
from selenium.webdriver import Keys
from selenium.webdriver.common.by import By
from selenium.webdriver.firefox.service import Service
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.ui import WebDriverWait
from utilities import connect_2_db_server, save_result_in_db

locale.setlocale(locale.LC_ALL, '')

def mail_ru_authorization(browser, name, password):
    user_elem = browser.find_element(By.XPATH, "//input[@name='username']")

    user_elem.send_keys(name)
    user_elem.send_keys(Keys.ENTER)

    wait = WebDriverWait(browser, 15)
    pass_elem = wait.until(EC.visibility_of_element_located((By.XPATH, "//input[@name='password']")))

    pass_elem.send_keys(password)
    pass_elem.send_keys(Keys.ENTER)

    if browser.title:
        return browser
    else:
        return False


def connect(site):
    s = Service('./geckodriver')

    try:
        driver = webdriver.Firefox(service=s)
        driver.maximize_window()
        driver.get(site)
        return driver
    except exceptions:
        return False


def normalize_letter_date(letter_date: str) -> str:
    date_list = letter_date.split(',')
    date = date_list[0]
    if date == 'Вчера':
        date_list[0] = str(datetime.date.today() - datetime.timedelta(days=1))
    elif date == 'Сегодня':
        date_list[0] = str(datetime.date.today())
    else:
        date = date.split()
        date[1] = date[1].capitalize()
        date.append(str(datetime.date.today().year))
        date = ' '.join(date)
        new_date = datetime.datetime.strptime(date, '%d %B %Y').date()
        date_list[0] = str(new_date)
    letter_date = ','.join(date_list)
    return letter_date


def get_letters_info(page_driver: webdriver) -> list:
    links_list = get_letters_links(page_driver)
    list_of_letters = []

    wait = WebDriverWait(page_driver, 20)
    for link in links_list:
        letters_info = {}
        page_driver.get(link)
        letter_author = wait.until(EC.visibility_of_element_located((By.CLASS_NAME, 'letter-contact'))).text
        letter_date = page_driver.find_element(By.XPATH, '//div[@class="letter__date"]').text
        letter_theme = page_driver.find_element(By.CLASS_NAME, 'thread-subject').text
        letter_text = page_driver.find_element(By.CLASS_NAME, 'letter-body').text
        letters_info['author'] = letter_author
        letters_info['date'] = normalize_letter_date(letter_date)
        letters_info['theme'] = letter_theme
        letters_info['text'] = letter_text
        letters_info['link'] = link
        list_of_letters.append(letters_info)
    return list_of_letters


def get_letters_links(page_driver: webdriver) -> list:
    letters_links_set = set()
    wait = WebDriverWait(page_driver, 20)
    page = wait.until(EC.visibility_of_element_located((By.XPATH, "//a[contains(@class, 'js-letter-list-item')]")))

    inbox = page.find_element(By.XPATH, "//a[@href='/inbox/']")

    number_of_letters = int(re.search(r'\s\d+\s', inbox.get_attribute('title'))[0])

    while len(letters_links_set) < number_of_letters:
        letters = page.find_elements(By.XPATH, "//a[contains(@class, 'js-letter-list-item')]")
        for letter in letters:
            link = letter.get_attribute('href')
            if link is None:
                continue
            else:
                letters_links_set.add(link)
        page_driver.execute_script('arguments[0].scrollIntoView()', letters[-1])
        time.sleep(1)

        page = wait.until(EC.visibility_of_element_located((By.XPATH, "//a[contains(@class, 'js-letter-list-item')]")))

    letters_link_list = list(letters_links_set)
    print(f'Собрано ссылок: {len(letters_link_list)}')
    return letters_link_list


def get_mail_from_server(site):
    # подключаемся к сайту
    user_name = input('Please enter your email: ')
    user_password = input('Please enter your password: ')
    connection = connect(site)
    if connection:
        mail_page = mail_ru_authorization(connection, user_name, user_password)
    else:
        print(f'соединение с сайтом по адресу {site} не выполнено')

    if mail_page:
        mail_list = get_letters_info(mail_page)
    else:
        print('something wrong')
    # закрываем соединение
    connection.close()
    return mail_list


def main():
    url = "https://account.mail.ru/login"
    letters = get_mail_from_server(url)

    # Создаем клиента для подключения к серверу
    client = connect_2_db_server()
    if client:
        # подключаемся к базе данных, указав её имя
        db = client['mail']
        collection = db.get_collection('mail_ru_letters')
        for letter in letters:
            save_result_in_db(letter, collection)
    else:
        print('Соединение с базой данных не установлено. '
              'Запись результатов невозможна')


if __name__ == '__main__':
    main()
